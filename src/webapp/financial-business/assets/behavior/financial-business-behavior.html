<!--Created by SkyLin on 2016/8/4.-->
<script>
    /**
     * @author Sky Lin
     * 金融服务前端功能具体实现
     */
    FinancialBusinessBehavior = {
        properties: {
            // 前端回显查询条件
            queryParam: {
                type: Object,
                value: {
                    start: 0,
                    limit: 10,
                    results: 0,
                    pageIndex: 1,
                    financialOrder: {
                        financeOrderNo: null,
                        customerCompanyId: null,
                        type: null,
                        orderChannel: null,
                        fundChannel: null,
                        overDate: null,
                        createdAtStart: null,
                        createdAtEnd: null,
                        interestSettleDateStart: null,
                        interestSettleDateEnd: null,
                        approveAtStart: null,
                        approveAtEnd: null,
                        status: 0,// 前端虚拟状态
                        realStatus: "0" // 数据库真实状态
                    }
                },
                notify: true
            },
            // 订单数组
            orders: {
                type: Array,
                notify: true
            },
            // 融资订单号数组
            orderNos: {
                type: Array,
                notify: true
            },
            // 融资订单号下拉搜索框表头
            orderCols: {
                type: Array,
                value: [{field: 'label', label: '融资订单号', width: '100'}]
            },
            // 客户名数组
            customerNames: {
                type: Array,
                notify: true
            },
            // 客户名下拉搜索框表头
            customerCols: {
                type: Array,
                value: [{field: 'label', label: '客户公司名称', width: '100'}]
            },
            //　产品类型
            proType: {
                type: Array,
                value: [{
                    value: '0',
                    label: "全部"
                }, {
                    value: '1',
                    label: "快易融"
                }, {
                    value: '99',
                    label: "其他"
                }]
            },
            //　订单渠道
            orderChannel: {
                type: Array,
                value: [{
                    value: '0',
                    label: "全部"
                }, {
                    value: '1',
                    label: "快塑网"
                }, {
                    value: '99',
                    label: "其他"
                }]
            },
            //　资金来源
            fundChannel: {
                type: Array,
                value: [{
                    value: '0',
                    label: "全部"
                }, {
                    value: '1',
                    label: "备用金"
                }, {
                    value: '99',
                    label: "其他"
                }]
            },
            //　逾期天数
            overdueDays: {
                type: Array,
                value: [{
                    value: '0',
                    label: "全部"
                }, {
                    value: '1',
                    label: "1~7天"
                }, {
                    value: '2',
                    label: "8~14天"
                }, {
                    value: '3',
                    label: "15~30天"
                }, {
                    value: '4',
                    label: "30天以上"
                }]
            },
            orderKeyword: {
                type: String,
                notify: true
            },
            companyKeyword: {
                type: String,
                notify: true
            }
        },
        /**
         * 根据参数查询金融订单
         * @param param
         */
        loadOrders: function () {
            var queryVo = this._setQueryParam();
            var self = this;
            var url = "/financialOrder/queryOrdersByParam.do";
            this.queryByComplexEntity(
                    url, queryVo,
                    function (data) {
                        console.log("查询金融订单成功");
                        if (data && data.financeOrders) {
                            self.set("orders", data.financeOrders);
                            self.set("queryParam.results", data.pageResponse.results);
                        } else {
                            self.set("orders", []);
                        }
                    },
                    function (err) {
                        console.log("查询金融订单失败");
                    }
            );
        },
        /**
         * 装载金融订单号下拉搜索框数组
         */
        loadOrderNo: function () {
            var param = {
                status: this.status
            };
            var self = this;
            var url = "/financialOrder/queryOrderNo.do";
            this.query(
                    url,
                    param,
                    function (data) {
                        self.set("orderNos", data);
                        console.log("查询金融订单号数组成功");
                    }, function () {
                        console.log("查询金融订单号数组失败");
                    }
            );
        },
        /**
         * 装载客户名下拉搜索框数组
         */
        loadCustomerName: function () {
            var param = {
                status: this.status
            };
            var self = this;
            var url = "/financialOrder/queryCustomerName.do";
            this.query(
                    url,
                    param,
                    function (data) {
                        self.set("customerNames", data);
                        console.log("查询客户名数组成功");
                    }, function () {
                        console.log("查询客户名数组失败");
                    }
            );
        },
        /**
         * 设置产品类型
         */
        setType: function (type) {
            for (var i = 0, length = this.proType.length; i < length; i++) {
                if (this.proType[i].value != type) {
                    continue;
                }
                return this.proType[i].label;
            }
            return "";
        },
        /**
         * 设置利率
         * @param rate
         */
        setRate: function (rate) {
            return rate * 100 + "%";
        },
        /**
         * 设置订单渠道
         */
        setOrderChannel: function (orderChannel) {
            for (var i = 0, length = this.orderChannel.length; i < length; i++) {
                if (this.orderChannel[i].value != orderChannel) {
                    continue;
                }
                return this.orderChannel[i].label;
            }
            return "";
        },
        /**
         * 设置申请时间 yyyy-MM-dd HH:mm格式
         * @param createAt
         */
        setCreateAt: function (createAt) {
            return this.date2Format(new Date(createAt), "yyyy-MM-dd hh:mm");
        },
        /**
         * 设置资金渠道
         */
        setFundChannel: function (fundChannel) {
            for (var i = 0, length = this.fundChannel.length; i < length; i++) {
                if (this.fundChannel[i].value != fundChannel) {
                    continue;
                }
                return this.fundChannel[i].label;
            }
            return "";
        },
        /**
         * 本息求和
         */
        sum: function (amount, interest) {
            return amount + interest;
        },
        /**
         * 计算逾期天数
         * @param interestSettleDate 时间毫秒值
         */
        calOverdueDays: function (interestSettleDate) {
            var date = new Date(interestSettleDate).setHours(0, 0, 0, 0);
            var now = new Date().setHours(0, 0, 0, 0);
            return (now - date) / (1000 * 60 * 60 * 24);
        },
        /**
         * 设置状态:1:待审核(approval);2:驳回(reject),3:待放款(pendingPayment),4:待回款(pendingReceipt),5:逾期(overdue),6:已回款(receipted),7:取消(cancel)
         */
        setStatus: function (status) {
            switch (status) {
                case 1:
                    return "待审核";
                    break;
                case 2:
                    return "已驳回";
                    break;
                case 3:
                    return "待放款";
                    break;
                case 4:
                    return "待回款";
                    break;
                case 5:
                    return "逾期";
                    break;
                case 6:
                    return "已回款";
                    break;
                case 7:
                    return "已取消";
                    break;
            }
        },
        /**
         * 设置历史订单的图标和颜色
         */
        setTagAndColor: function (status) {
            switch (status) {
                case 2:
                    return "status-tag s-red";
                    break;
                case 6:
                    return "status-tag s-gray";
                    break;
                case 7:
                    return "status-tag s-yellow";
                    break;
                default:
                    return "status-tag s-red";
                    break;
            }
        },
        /**
         * 重置按钮
         */
        reset: function (e) {
            // pageIndex被改变的时候会触发loadOrders查询方法
            this.set("queryParam", {
                start: 0,
                limit: 10,
                results: 0,
                pageIndex: 1,
                financialOrder: {
                    financeOrderNo: null,
                    customerCompanyId: this.companyId || null,
                    type: null,
                    orderChannel: null,
                    fundChannel: null,
                    overDate: null,
                    createdAtStart: null,
                    createdAtEnd: null,
                    interestSettleDateStart: null,
                    interestSettleDateEnd: null,
                    approveAtStart: null,
                    approveAtEnd: null,
                    status: this.status,
                    realStatus: "0"
                }
            });
            this.set("orderKeyword", null);
            this.set("companyKeyword", null);
        },
        /**
         * 打开订单详情
         */
        openTabOrderDetail: function (e) {
            var id = e.target.name;
            var orderNo = e.target.orderNo;
            $("#mainIndex")[0]._showTabPage("order_" + orderNo, id);
        },
        /**
         * 格式化查询参数
         */
        _setQueryParam: function () {
            var queryVo = {};
            $.extend(queryVo, this.queryParam);
            var order = this.queryParam.financialOrder;
            if (order.createdAtStart) {
                queryVo.financialOrder.createdAtStart = +new Date(order.createdAtStart);
            }
            if (order.createdAtEnd) {
                queryVo.financialOrder.createdAtEnd = +new Date(order.createdAtEnd);
            }
            if (order.interestSettleDateStart) {
                queryVo.financialOrder.interestSettleDateStart = +new Date(order.interestSettleDateStart);
            }
            if (order.interestSettleDateEnd) {
                queryVo.financialOrder.interestSettleDateEnd = +new Date(order.interestSettleDateEnd);
            }
            if (order.approveAtStart) {
                queryVo.financialOrder.approveAtStart = +new Date(order.approveAtStart);
            }
            if (order.approveAtEnd) {
                queryVo.financialOrder.approveAtEnd = +new Date(order.approveAtEnd);
            }
            return queryVo;
        },
        /**
         * 审核通过或驳回成功时刷新审核列表页面数据
         * @private
         */
        refreshPendingOrderList: function () {
            /**
             * 拿到导航栏标题头数组
             */
            var tabPages = $("#mainIndex")[0].tabPages;
            if (!tabPages || tabPages.length == 0) {
                return;
            }
            /**
             * 如果已经打开了待审核列表页面,则刷新该页面数据,否则不刷新
             */
            for (var i = 0, length = tabPages.length; i < length; i++) {
                if (tabPages[i].id = "approval") {
                    $('financial-business-check-pending')[0]._init();
                    break;
                }
            }
        }
    };
</script>